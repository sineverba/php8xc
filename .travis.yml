os: linux
dist: focal
language: shell

services:
  - docker

env:
  DOCKER_USERNAME: sineverba
  DOCKER_IMAGE: php8xc

before_install:
  - docker -v | grep "19.03"
  - mkdir -vp ~/.docker/cli-plugins/
  - curl --silent -L "https://github.com/docker/buildx/releases/download/v0.5.1/buildx-v0.5.1.linux-amd64" > ~/.docker/cli-plugins/docker-buildx
  - chmod a+x ~/.docker/cli-plugins/docker-buildx
  - docker buildx version

install:
  - echo "$DOCKER_TOKEN" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - docker build --tag $DOCKER_USERNAME/$DOCKER_IMAGE .

script:
  - docker run --rm $DOCKER_USERNAME/$DOCKER_IMAGE php -v | grep 8.0.1
  - docker run --rm $DOCKER_USERNAME/$DOCKER_IMAGE php -v | grep OPcache
  - docker run --rm $DOCKER_USERNAME/$DOCKER_IMAGE php -m | grep xdebug
  - docker run --rm $DOCKER_USERNAME/$DOCKER_IMAGE php -r "xdebug_info();" | grep "3.0.2"
  - docker run --rm $DOCKER_USERNAME/$DOCKER_IMAGE php -m | grep pdo_pgsql
  - docker run --rm $DOCKER_USERNAME/$DOCKER_IMAGE /usr/bin/composer -V | grep "2.0.9"
  - docker run --rm $DOCKER_USERNAME/$DOCKER_IMAGE php -i | grep "short_open_tag => Off => Off"
  - docker run --rm $DOCKER_USERNAME/$DOCKER_IMAGE php -i | grep "memory_limit => 512M => 512M"

after_success:
  - |
    if [[ $TRAVIS_TAG != "" ]]; then
      echo "$DOCKER_TOKEN" | docker login -u "$DOCKER_USERNAME" --password-stdin || travis_terminate 1;
      docker run --rm --privileged multiarch/qemu-user-static --reset -p yes || travis_terminate 1;
      docker buildx create --name mybuilder && docker buildx use mybuilder && docker buildx inspect --bootstrap || travis_terminate 1;
      docker buildx build \
        --platform linux/amd64,linux/arm \
        --tag $DOCKER_USERNAME/$DOCKER_IMAGE:$TRAVIS_TAG \
        --tag $DOCKER_USERNAME/$DOCKER_IMAGE:latest \
        --push . || travis_terminate 1;
    fi